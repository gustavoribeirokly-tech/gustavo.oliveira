<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Mental - Investigação de Incidente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #f8fafc;
      }
      .node-rect {
        cursor: pointer;
        transition: filter 0.2s;
      }
      .node-rect:hover {
        filter: brightness(1.1);
      }
      .link {
        fill: none;
        stroke: #008080;
        stroke-width: 2px;
        stroke-opacity: 0.3;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #008080;
        border-radius: 4px;
      }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom": "https://esm.sh/react-dom@^19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@^19.2.3/client",
    "d3": "https://esm.sh/d3@^7.9.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useEffect, useRef, useState } from 'react';
      import ReactDOM from 'react-dom/client';
      import * as d3 from 'd3';

      // --- DATA ---
      const mindMapData = {
        name: "VARIAÇÃO DE HASTE DA SONDA NA TRA-75_02 ATINGINDO A CR-436 (TBSA)",
        children: [
          {
            name: "Descrição do Evento",
            children: [
              {
                name: "Local e Data",
                children: [
                  { name: "Local: TRA-75_02, Juazeiro-BA" },
                  { name: "Data/Hora: 15/12/2025, 08h20min" }
                ]
              },
              {
                name: "Ocorrência Principal",
                children: [
                  { name: "Operador (José D. dos Santos Silva) limpava frente GAN-75-01" },
                  { name: "Operava Carregadeira de pneus CR-436" },
                  { name: "Manobra de ré na TRA-75_02" },
                  { name: "Colisão com haste de sonda varada na galeria" },
                  { name: "Dano: Parabrisa danificado, haste ultrapassou o vidro 30 cm" }
                ]
              },
              {
                name: "Classificação",
                children: [
                  { name: "PG-5 (Danos Materiais)" },
                  { name: "Atividade: Controlada" },
                  { name: "Metodologia de Análise: Diagrama de Ishikawa, Árvore de Causas" }
                ]
              }
            ]
          },
          {
            name: "Causas Raiz (Análise 'Porquês')",
            children: [
              {
                name: "Causa Imediata: Colisão com Haste",
                children: [
                  { name: "Haste estava suspensa no meio da galeria" },
                  { name: "Carregadeira em manobra de ré em ponto operacional" }
                ]
              },
              {
                name: "Causa da Haste na Galeria (Perda de Confinamento)",
                children: [
                  { name: "Perda de confinamento após desmonte" },
                  { name: "Avanço da ferramenta da sonda (pescador) por dedução do sondador" },
                  { name: "Furo (FVS-2230) atravessou frente desmontada (descontinuidade do maciço)" }
                ]
              },
              {
                name: "Causa de Programação (Falha de Validação)",
                children: [
                  { name: "Programação de sondagem ajustada / incompleta (Complemento de furos)" },
                  { name: "String do furo varado (FVS-2230) não enviada ao Planejamento para validação" },
                  { name: "Ausência de protocolo formal (assinaturas/carimbo) para liberação" },
                  { name: "Falha no processo de envio da string e liberação da programação" }
                ]
              },
              {
                name: "Fatores Humanos e Processuais",
                children: [
                  { name: "Inexperiência do Geólogo Programador (45 dias em ambientação)" },
                  { name: "Treinamento técnico insuficiente do programador" },
                  { name: "Controle frágil de versões e validações cruzadas" },
                  { name: "Furo atravessando frente carregada antes do desmonte" }
                ]
              }
            ]
          },
          {
            name: "Linha do Tempo (Eventos Críticos FVS-2230)",
            children: [
              {
                name: "10/Dez",
                children: [
                  { name: "Envio incompleto da programação ao Planejamento (faltando 1 furo)" },
                  { name: "Entrega da programação à Major antes da validação do Planejamento" }
                ]
              },
              {
                name: "11/Dez",
                children: [
                  { name: "Planejamento valida programação (considerando apenas 4 furos)" }
                ]
              },
              {
                name: "12/Dez",
                children: [
                  { name: "Furo FVS-2230 embocado" },
                  { name: "Furo atravessava região com explosivo (frente carregada)" }
                ]
              },
              {
                name: "13/Dez",
                children: [
                  { name: "Desmonte da TRA-75_02 no final do turno (interceptou o furo)" },
                  { name: "Sonda parou por falta d'água (48,22 m de profundidade)" }
                ]
              },
              {
                name: "15/Dez (Dia do Acidente)",
                children: [
                  { name: "00h-06h: Tentativa de saque do tubo interno sem sucesso" },
                  { name: "00h-06h: Haste quebrada e barrilete identificados no furo" },
                  { name: "06h-12h: Tentativa de pesca (inseridos 15m adicionais)" },
                  { name: "06h-12h: Hastes arqueadas na galeria" },
                  { name: "08h20min: Colisão da Carregadeira com haste suspensa" }
                ]
              }
            ]
          },
          {
            name: "Ações Imediatas",
            children: [
              { name: "Comunicação à liderança (ERO, TBSA)" },
              { name: "Segurança do Trabalho informada imediatamente" },
              { name: "Local preservado" },
              { name: "Registro fotográfico (Equipe Geologia e Segurança ERO)" },
              { name: "Bafometria e Toxicológico (Envolvidos Major Drilling e Toniolo)" }
            ]
          },
          {
            name: "Outras Ocorrências de Varação (Visão Consolidada)",
            children: [
              { name: "Total de 12 ocorrências registradas" },
              { name: "Natureza predominante: Varação de furo de sondagem" },
              { name: "3 registros classificados como Quase Acidente" },
              { name: "Ambiente Crítico: Galerias e níveis operacionais ativos" },
              { name: "Risco Associado: Interferência operacional, dano a ativos" }
            ]
          }
        ]
      };

      // --- COMPONENTS ---

      const MindMapCanvas = () => {
        const svgRef = useRef(null);
        const containerRef = useRef(null);

        useEffect(() => {
          if (!svgRef.current || !containerRef.current) return;

          const width = containerRef.current.clientWidth;
          const height = containerRef.current.clientHeight;
          const margin = { top: 20, right: 120, bottom: 20, left: 240 };
          
          const dx = 70; 
          const dy = 450; 

          const svg = d3.select(svgRef.current)
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [-margin.left, -margin.top, width, height].join(' '))
            .style("font", "12px sans-serif")
            .style("user-select", "none");

          svg.selectAll("*").remove();

          const gLink = svg.append("g").attr("class", "links-group");
          const gNode = svg.append("g").attr("class", "nodes-group");

          const root = d3.hierarchy(mindMapData);
          root.x0 = dy / 2;
          root.y0 = 0;

          if (root.children) {
            root.children.forEach(child => {
              if (child.children) {
                child._children = child.children;
                child.children = undefined;
              }
            });
          }

          const tree = d3.tree().nodeSize([dx, dy]);

          const update = (source) => {
            const duration = 250;
            tree(root);

            const nodes = root.descendants().reverse();
            const links = root.links();

            const transition = svg.transition().duration(duration);

            const node = gNode.selectAll("g")
              .data(nodes, d => d.id || (d.id = Math.random().toString(36).substr(2, 9)));

            const nodeEnter = node.enter().append("g")
              .attr("transform", d => `translate(${source.y0},${source.x0})`)
              .attr("fill-opacity", 0)
              .attr("stroke-opacity", 0)
              .on("click", (event, d) => {
                if (d.children) {
                  d._children = d.children;
                  d.children = undefined;
                } else {
                  d.children = d._children;
                  d._children = undefined;
                }
                update(d);
              });

            nodeEnter.append("rect")
              .attr("class", "node-rect")
              .attr("rx", 6)
              .attr("ry", 6)
              .attr("y", -18)
              .attr("x", 0)
              .attr("height", 36)
              .attr("width", d => {
                const label = d.data.name;
                return Math.min(Math.max(label.length * 8.5, 140), 420);
              })
              .attr("fill", "#008080")
              .attr("stroke", "#ffffff")
              .attr("stroke-width", 1);

            nodeEnter.append("text")
              .attr("dy", "0.31em")
              .attr("x", 12)
              .attr("text-anchor", "start")
              .attr("fill", "#ffffff")
              .style("font-weight", "500")
              .text(d => d.data.name);

            node.merge(nodeEnter).transition(transition)
              .attr("transform", d => `translate(${d.y},${d.x})`)
              .attr("fill-opacity", 1)
              .attr("stroke-opacity", 1);

            node.exit().transition(transition).remove()
              .attr("transform", d => `translate(${source.y},${source.x})`)
              .attr("fill-opacity", 0)
              .attr("stroke-opacity", 0);

            const link = gLink.selectAll("path")
              .data(links, d => d.target.id);

            const linkEnter = link.enter().append("path")
              .attr("class", "link")
              .attr("d", d => {
                const o = { x: source.x0, y: source.y0 };
                return d3.linkHorizontal()({ source: o, target: o });
              });

            link.merge(linkEnter).transition(transition)
              .attr("d", d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x));

            link.exit().transition(transition).remove()
              .attr("d", d => {
                const o = { x: source.x, y: source.y };
                return d3.linkHorizontal()({ source: o, target: o });
              });

            nodes.forEach(d => {
              d.x0 = d.x;
              d.y0 = d.y;
            });
          };

          update(root);

          const zoom = d3.zoom().on("zoom", (event) => {
            svg.selectAll("g.links-group, g.nodes-group").attr("transform", event.transform);
          });

          svg.call(zoom);
          const initialTransform = d3.zoomIdentity.translate(80, height / 2).scale(0.75);
          svg.call(zoom.transform, initialTransform);

        }, []);

        return (
          <div ref={containerRef} className="w-full h-screen bg-slate-50 relative overflow-hidden">
            <svg ref={svgRef} className="w-full h-full cursor-grab active:cursor-grabbing" />
            <div className="absolute bottom-6 left-6 bg-white/90 p-4 rounded-xl border border-slate-200 shadow-lg backdrop-blur-md">
              <h3 className="text-xs font-bold text-teal-800 uppercase tracking-widest mb-3 border-b border-teal-100 pb-2">Controles de Navegação</h3>
              <ul className="text-xs space-y-2 text-slate-600">
                <li className="flex items-center"><span className="w-2.5 h-2.5 rounded-full bg-teal-600 mr-3"></span> Clique para expandir/recolher níveis</li>
                <li className="flex items-center"><span className="w-2.5 h-2.5 rounded-full bg-teal-600 mr-3"></span> Arraste o fundo para mover o mapa</li>
                <li className="flex items-center"><span className="w-2.5 h-2.5 rounded-full bg-teal-600 mr-3"></span> Role para aumentar ou diminuir zoom</li>
              </ul>
            </div>
          </div>
        );
      };

      const App = () => {
        const tealFilter = {
          filter: 'brightness(0) saturate(100%) invert(31%) sepia(87%) saturate(1476%) hue-rotate(143deg) brightness(91%) contrast(101%)'
        };

        const logoUrl = "https://media.zenfs.com/en/globenewswire.com/8e25793c387f15dc92c59c30b34df6c6";

        return (
          <div className="flex flex-col h-screen font-sans antialiased text-slate-900 overflow-hidden bg-slate-50">
            <header className="absolute top-0 left-0 right-0 z-20 flex flex-col md:flex-row justify-between items-start p-6 pointer-events-none gap-4">
              <div className="pointer-events-auto bg-white/90 p-5 rounded-2xl shadow-xl border border-slate-200 backdrop-blur-md transition-all hover:shadow-2xl">
                <h1 className="text-2xl font-black text-[#008080] tracking-tight leading-tight">RELATÓRIO DE INVESTIGAÇÃO</h1>
                <p className="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mt-1 flex items-center gap-2">
                  <span className="w-2 h-2 rounded-full bg-[#008080] animate-pulse"></span>
                  Incidente Operacional • TBSA
                </p>
              </div>
              
              <div className="pointer-events-auto bg-white/95 px-8 py-5 rounded-2xl shadow-xl border border-slate-200 backdrop-blur-md self-end md:self-start">
                 <div className="flex flex-col items-center justify-center min-w-[120px]">
                   <img 
                     src={logoUrl} 
                     alt="ERO Copper Logo" 
                     className="h-12 md:h-16 w-auto object-contain transition-all duration-500 hover:scale-110"
                     style={tealFilter}
                   />
                 </div>
              </div>
            </header>

            <main className="flex-1 relative z-10">
              <MindMapCanvas />
            </main>

            <footer className="absolute bottom-0 right-0 p-4 z-20 pointer-events-none">
              <div className="bg-[#008080] text-white text-[10px] px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-white/20 backdrop-blur-lg pointer-events-auto">
                <div className="relative flex h-2 w-2">
                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-teal-300 opacity-75"></span>
                  <span className="relative inline-flex rounded-full h-2 w-2 bg-teal-200"></span>
                </div>
                <span className="font-bold tracking-[0.15em] uppercase">Visualização de Causa Raiz • Mapa Interativo</span>
              </div>
            </footer>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>